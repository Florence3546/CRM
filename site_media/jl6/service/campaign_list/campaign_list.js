define("jl6/site_media/service/campaign_list/campaign_list",["require","jl6/site_media/plugins/artTemplate/template","jl6/site_media/plugins/moment/moment.min","jl6/site_media/service/common/common","jl6/site_media/plugins/data-tables/dataTableExt","jl6/site_media/widget/ajax/ajax","jl6/site_media/widget/loading/loading","jl6/site_media/widget/confirm/confirm","jl6/site_media/widget/lightMsg/lightMsg","jl6/site_media/widget/alert/alert","jl6/site_media/service/report_detail/report_detail"],function(t,a,e,n,i,s,d,c,o,l,r){"use strict";var p,_=[],u=e().subtract(7,"days").format("YYYY-MM-DD"),m=e().subtract(1,"days").format("YYYY-MM-DD"),h=function(){b(u,m),$("#show_subdivide_all").on("click",function(){if(!$(this).data("is_lock")){$(this).data("is_lock",1);var t=$(this).data("is_showing");$.map($("#campaign_table .show_subdivide"),function(a){$(a).data("is_showing")==t&&$(a).click()}),t?delete $(this).data().is_showing:$(this).data("is_showing",1),delete $(this).data().is_lock}})},v=function(){_=[],$("#campaign_table .check_column input").each(function(){this.checked?(_.push(this.value),$(this).parent("td").addClass("tr-checked")):$(this).parent("td").removeClass("tr-checked")})},f=function(){$("#campaign_table .check_column").shiftcheckbox({checkboxSelector:"input",selectAll:$("#campaign_table .all"),onChange:function(){v()}}).on("click","input",function(){v()}),$("#campaign_table .edit_title").on("click",function(){var t,a;t=$(this).closest("td"),a=$.trim(t.find(".title>a").text()),t.find("input[name=input_title]").val(a),t.find(".j_text_len").text(n.true_length(a)),t.addClass("editor")}),$("#campaign_table .editor_title>input[name=input_title]").on("keyup",function(){var t=40,a=this.value,e=n.true_length(a);e>t&&(this.value=a.slice(0,a.length-1),e=t),$(this).parent(".editor_title").find(".j_text_len").text(e)}),$("#campaign_table .save_title").on("click",function(){var t,a,e;return t=$(this).closest("td"),a=$.trim(t.find(".title").text()),e=$.trim(t.find("input[name=input_title]").val()),""==e?void o.show({body:"计划名称不能为空"}):void(a==e?t.removeClass("editor"):s.ajax("modify_camp_title",{camp_id:$(this).closest("tr").attr("id"),new_title:e},function(a){a.errMsg?o.show({body:a.errMsg}):(t.find(".title>a").text(e),o.show({body:"修改计划名称成功！"}),t.removeClass("editor"),$("#li_camp_"+a.json_result_data.camp_id+" .camp_title").html(e))}))}),$("#campaign_table .cancel_modify_title").on("click",function(){$(this).closest("td").removeClass("editor")}),$("#campaign_table .show_chart").on("click",function(){var t,a;t=$(this).closest("tr").find(".title").text(),a=$(this).closest("tr").data("id"),r.show("计划明细："+t,"campaign",$("#shop_id").val(),a)}),$("#campaign_table .show_subdivide").on("click",function(){if(!$(this).data("is_lock")){$(this).data("is_lock",1);var t,e,n,i,d='<tr class="hover_non_color">\n    <td rowspan="4" colspan="3"></td>\n    <td rowspan="2">计算机</td>\n    <td>站内</td>\n    {{ if pcin }}\n    <td>{{ pcin.impr}}</td>\n    <td>{{ pcin.click}}</td>\n    <td>{{ pcin.ctr}}%</td>\n    <td>￥{{ pcin.cost}}</td>\n    <td>￥{{ pcin.cpc}}</td>\n    <td>{{ pcin.favcount}}</td>\n    <td>{{ pcin.carttotal}}</td>\n    <td>{{ pcin.paycount}}</td>\n    <td>{{ pcin.conv}}%</td>\n    <td>￥{{ pcin.pay}}</td>\n    <td>{{ pcin.roi}}</td>\n    {{ else }}\n        <td class="tc item_base" colspan="11">暂无数据</td>\n    {{ /if }}\n    <td rowspan="4" colspan="2"></td>\n</tr>\n<tr class="hover_non_color">\n\n    <td>站外</td>\n    {{ if pcout }}\n    <td>{{pcout.impr}}</td>\n    <td>{{pcout.click}}</td>\n    <td>{{pcout.ctr}}%</td>\n    <td>￥{{pcout.cost}}</td>\n    <td>￥{{pcout.cpc}}</td>\n    <td>{{pcout.favcount}}</td>\n    <td>{{ pcout.carttotal}}</td>\n    <td>{{pcout.paycount}}</td>\n    <td>{{pcout.conv}}%</td>\n    <td>￥{{pcout.pay}}</td>\n    <td>{{pcout.roi}}</td>\n    {{ else }}\n        <td class="tc item_base" colspan="11">暂无数据</td>\n    {{ /if }}\n</tr>\n<tr class="hover_non_color">\n    <td rowspan="2">移动</td>\n    <td>站内</td>\n    {{ if ydin }}\n    <td>{{ydin.impr}}</td>\n    <td>{{ydin.click}}</td>\n    <td>{{ydin.ctr}}%</td>\n    <td>￥{{ydin.cost}}</td>\n    <td>￥{{ydin.cpc}}</td>\n    <td>{{ydin.favcount}}</td>\n    <td>{{ ydin.carttotal}}</td>\n    <td>{{ydin.paycount}}</td>\n    <td>{{ydin.conv}}%</td>\n    <td>￥{{ydin.pay}}</td>\n    <td>{{ydin.roi}}</td>\n    {{ else }}\n        <td class="tc item_base" colspan="11">暂无数据</td>\n    {{ /if }}\n</tr>\n<tr class="hover_non_color">\n    <td>站外</td>\n    {{ if ydout }}\n   <td>{{ydout.impr}}</td>\n    <td>{{ydout.click}}</td>\n    <td>{{ydout.ctr}}%</td>\n    <td>￥{{ydout.cost}}</td>\n    <td>￥{{ydout.cpc}}</td>\n    <td>{{ydout.favcount}}</td>\n    <td>{{ ydout.carttotal}}</td>\n    <td>{{ydout.paycount}}</td>\n    <td>{{ydout.conv}}%</td>\n    <td>￥{{ydout.pay}}</td>\n    <td>{{ydout.roi}}</td>\n    {{ else }}\n        <td class="tc item_base" colspan="11">暂无数据</td>\n    {{ /if }}\n</tr>\n',c=this;if(i=$(this).closest("tr"),n=i.data("id"),$(this).data("is_showing"))i.data("subdivide").remove(),delete $(this).data().is_showing,delete $(this).data().is_lock;else if(i.data("subdivide")){var e=i.data("subdivide");i.after(e),$(this).data("is_showing",1),delete $(this).data().is_lock}else s.ajax("get_aggregate_rpt",{camp_id:n,start_date:u,end_date:m},function(s){for(var o=s.result,l={id:n},r=0;r<o.length;r++){var p=o[r];switch(p.source_id){case 1:l.pcin=p;break;case 2:l.pcout=p;break;case 4:l.ydin=p;break;case 5:l.ydout=p}}t=a.compile(d)(l),e=$(t),i.after(e),$(i).data("subdivide",e),$(c).data("is_showing",1),delete $(c).data().is_lock})}}),$("#campaign_table .edit_budget").on("click",function(){var a,e,n,i=$(this),d=$(this).prev();e=$(this).closest("tr").data("id"),a=$(this).data("budget"),n=$(this).data("smooth");var c=$(this).closest("tr").attr("mnt_type");t(["jl6/site_media/service/edit_camp_budget/edit_camp_budget"],function(t){t.show({campaign_id:e,budget:a,is_smooth:n,mnt_type:c,onChange:function(t,c){if(t!=a||c!=n){var r;r="0"==c?"false":"true",s.ajax("modify_camp_budget",{camp_id:e,use_smooth:r,budget:t},function(a){return a.errMsg?void l.show(a.errMsg):(d.text(2e7>t?t+"元":"不限"),i.data("budget",t),i.data("smooth",c),void o.show({body:"修改日限额成功！"}))})}}})})}),$("#campaign_table .edit_platform").on("click",function(){var a=$(this).closest("tr").data("id");d.show("正在获取计划投放平台"),s.ajax("get_camp_platform",{camp_id:a},function(e){d.hide();var n=e.platform,i=e.can_set_nonsearch;n?t(["jl6/site_media/service/edit_camp_platform/edit_camp_platform"],function(t){t.show({pc_insite_search:n.pc_insite_search,pc_outsite_nonsearch:n.pc_outsite_nonsearch,pc_insite_nonsearch:n.pc_insite_nonsearch,outside_discount:n.outside_discount,yd_outsite:n.yd_outsite,pc_outsite_search:n.pc_outsite_search,mobile_discount:n.mobile_discount,yd_insite:n.yd_insite,can_set_nonsearch:i,onChange:function(t){d.show("正在设置计划投放平台"),s.ajax("update_camp_platform",{camp_id:a,platform_dict:JSON.stringify(t)},function(t){d.hide(),t.is_success?o.show({body:"修改计划投放平台成功！"}):l.show("修改计划投放平台失败")})}})}):l.show("淘宝接口不稳定，请稍候再试")})}),$("#campaign_table .edit_schedule").on("click",function(){d.show("正在获取分时折扣");var a=$(this).closest("tr").data("id");s.ajax("get_camp_schedule",{camp_id:a},function(e){d.hide(),e.schedule_str?t(["jl6/site_media/service/edit_camp_schedule/edit_camp_schedule"],function(t){t.show({schedules:e.schedule_str,onChange:function(t){s.ajax("update_camp_schedule",{camp_id:a,schedule_str:t},function(t){t.errMsg?l.show(t.errMsg):o.show({body:"修改计划分时折扣成功"})})}})}):l.show("淘宝接口不稳定，请稍候再试")})}),$(document).on("click",".update_camp",function(){var t=parseInt($(this).attr("mode")),a=[],e=t?"启动推广":"暂停推广";if($(this).hasClass("single"))return a=[parseInt($(this).parents("tr").attr("data-id"))],void c.show({body:"确定"+e+"这个计划吗？",okHide:function(){g(t,a)}});var n=$("#campaign_table tbody input:checked");n.each(function(){a.push(parseInt($(this).val()))}),a.length?c.show({body:"确定"+e+"所选的"+a.length+"个计划吗？",okHide:function(){g(t,a)}}):o.show({body:"请选择要操作的计划"})}),$(document).on("click",".change_camp_mnt",function(){var t=$(this).parents("tr"),a=t.attr("id"),e=parseInt(t.attr("mnt_type")),n=parseInt($(this).attr("type"));if(n)y(a);else{var i="确定“取消托管”该计划吗？",d=Number($(this).attr("mnt_days"));d>=-10&&0>d?i="该计划只托管了"+Math.abs(d)+"天，"+i:0==d&&(i="该计划托管不满1天，"+i);var l="<div class='lh25'>1、效果需要一定周期培养，建议不要短期托管或频繁更换策略</div><div class='lh25'>2、系统会停止优化您的宝贝，但不会改变计划和宝贝的推广状态</div><div class='lh25'>3、取消后可以重新开启托管，但需要重新设置计划、宝贝、策略</div>";c.show({title:i,body:l,cancleStr:"不取消托管",okStr:"取消托管",okHidden:function(){s.ajax("mnt_campaign_setter",{campaign_id:a,set_flag:0,mnt_type:e},function(){var t=$("#"+a),e="/web/adgroup_list/"+a,n=t.attr("mnt_index");$("#main_nav li.mnt_index:eq("+(Number(n)-1)+") a").attr("blank_mnt_index",n).html(n+"号引擎[未启动]"),t.attr({mnt_type:0,mnt_index:0}),t.find(".change_camp_mnt").text("开启托管").attr("type",1),t.find(".mnt_desc").text("手动"),t.find(".mnt_desc").removeClass("label-primary").addClass("label-default"),$("#title_"+a).attr("href",e),$("#li_camp_"+a).remove(),o.show({title:"托管状态修改",style:"default",body:"取消托管成功",timeout:5e3})},null,{url:"/mnt/ajax/"})}})}})},b=function(t,e){var n,i='{{each list}}\n<tr data-id="{{$value.campaign_id}}"  id="{{$value.campaign_id}}" mnt_type="{{$value.mnt_type}}" mnt_index="{{$value.mnt_index}}" {{if $value.online_status=="offline"}}class="gray_light"{{/if}}>\n    <td class="check_column"><input type="checkbox" value="{{$value.campaign_id}}"></td>\n    <td>\n      <span class="title">\n          <a class="item_base" title="{{$value.title}}" target="_blank" href="/mnt/mnt_campaign/{{ $value.campaign_id }}">{{$value.title}}</a>\n      </span>\n      {{ if $value.mnt_type == 0 }}\n          <span class="label label-default mnt_desc">手动</span>\n      {{ else }}\n          <span class="label label-primary mnt_desc">\n          {{ if $value.mnt_type == 1}} 长尾\n          {{else if $value.mnt_type == 2}} 重点\n          {{else if $value.mnt_type == 3}} ROI\n          {{else if $value.mnt_type == 4}} 无线\n          {{/if}}\n          </span>\n      {{/if}}\n\n      <span class="ml10">({{$value.adg_num}}个宝贝)</span>\n      &ensp;<i class="iconfont edit_title">&#xe609;</i>\n      &ensp;<i class="iconfont show_chart">&#xe60c;</i>\n      &ensp;<i class="iconfont show_subdivide">&#xe60a;</i>\n      <div class="editor_title">\n	      <input name="input_title" class="w230">\n		  <div>\n		      <span class="gray">已输入<span class="j_text_len"></span>/40</span>\n		      <div class="r">\n			      <a href="javascript:;" class="save_title">保存</a>\n			      <a href="javascript:;" class="cancel_modify_title">取消</a>\n		      </div>\n		  </div>\n      </div>\n    </td>\n    <td>\n      <span class="budget">\n        {{if $value.budget==20000000}}\n          不限\n        {{else}}\n          {{$value.budget}}元\n        {{/if}}\n      </span>\n      <i class="iconfont edit_budget" data-budget="{{$value.budget}}" data-smooth="{{$value.is_smooth}}">&#xe609;</i>\n    </td>\n    <td>\n      {{ if $value.yd_search==\'1\' }}移动设备<br>{{ /if }}\n      计算机&ensp;<i class="iconfont edit_platform">&#xe609;</i>\n    </td>\n    <td>\n        {{$value.schedule}}%\n        <i class="iconfont edit_schedule">&#xe609;</i>\n    </td>\n    <td><span class="hide">{{$value.impr}}</span>{{$value.impr}}</td>\n    <td><span class="hide">{{$value.click}}</span>{{$value.click}}</td>\n    <td><span class="hide">{{$value.ctr}}</span>{{$value.ctr}}%</td>\n    <td><span class="hide">{{$value.cost}}</span>￥{{$value.cost}}</td>\n    <td><span class="hide">{{$value.cpc}}</span>￥{{$value.cpc}}</td>\n    <td><span class="hide">{{$value.favcount}}</span>{{$value.favcount}}</td>\n    <td><span class="hide">{{$value.carttotal}}</span>{{$value.carttotal}}</td>\n    <td><span class="hide">{{$value.paycount}}</span>{{$value.paycount}}</td>\n    <td><span class="hide">{{$value.conv}}</span>{{$value.conv}}%</td>\n    <td><span class="hide">{{$value.pay}}</span>￥{{$value.pay}}</td>\n    <td><span class="hide">{{$value.roi}}</span>{{$value.roi}}</td>\n    <td>\n      {{if $value.online_status=="offline"}}\n        <span class="b">\n        已暂停\n        </span>\n        <a class="hover_show update_camp single" mode="1" href="javascript:;">开启</a>\n      {{else}}\n        <span class="b">\n        推广中\n        </span>\n        <a class="hover_show update_camp single" mode="0" href="javascript:;">暂停</a>\n      {{/if}}\n      {{ if $value.error_descr }}\n         <br/>{{ $value.error_descr }}\n      {{ /if }}\n    </td>\n    <td class="b tc">\n        <a href="/mnt/mnt_campaign/{{$value.campaign_id}}">进入计划</a><br>\n        {{if $value.mnt_type==0}}\n          <a href="javaScript:;" class="change_camp_mnt" type=1> 开启托管 </a>\n        {{else}}\n          <a href="javaScript:;" class="change_camp_mnt" mnt_days="{{ $value.mnt_days }}" type=0> 取消托管 </a>\n        {{/if}}\n    </td>\n</tr>\n{{/each}}\n';s.ajax("get_campaign_list",{start:t,end:e},function(t){n=a.compile(i)({list:t.json_campaign_list}),p&&(p.fnClearTable(),p.fnDestroy()),$("#campaign_table tbody").html(n),f(),p=$("#campaign_table").dataTable({bRetrieve:!0,bPaginate:!1,bDestroy:!0,bFilter:!0,bInfo:!1,bAutoWidth:!1,sDom:"",aoColumns:[{bSortable:!1},{bSortable:!1},{bSortable:!1},{bSortable:!1},{bSortable:!1},{bSortable:!0,sType:"custom",sSortDataType:"custom-text"},{bSortable:!0,sType:"custom",sSortDataType:"custom-text"},{bSortable:!0,sType:"custom",sSortDataType:"custom-text"},{bSortable:!0,sType:"custom",sSortDataType:"custom-text"},{bSortable:!0,sType:"custom",sSortDataType:"custom-text"},{bSortable:!0,sType:"custom",sSortDataType:"custom-text"},{bSortable:!0,sType:"custom",sSortDataType:"custom-text"},{bSortable:!0,sType:"custom",sSortDataType:"custom-text"},{bSortable:!0,sType:"custom",sSortDataType:"custom-text"},{bSortable:!0,sType:"custom",sSortDataType:"custom-text"},{bSortable:!0,sType:"custom",sSortDataType:"custom-text"},{bSortable:!1},{bSortable:!1}],fnDrawCallback:function(){delete $("#show_subdivide_all").data().is_showing,delete $("#show_subdivide_all").data().is_lock,$.map($("#campaign_table .show_subdivide"),function(t){delete $(t).data().is_showing,delete $(t).data().is_lock})}})})},g=function(t,a){s.ajax("update_camps_status",{camp_id_list:a,mode:t},function(a){if(0===a.success_camp_ids.length)return void l.show("修改失败：淘宝接口不稳定，请稍候再试");if(t)for(var e=0;e<a.success_camp_ids.length;e++){var n=a.success_camp_ids[e],i=$("#"+n),s=i.find(".update_camp");i.removeClass("gray_light"),s.prev().text("推广中"),s.attr("mode",0).text("暂停")}else for(var e=0;e<a.success_camp_ids.length;e++){var n=a.success_camp_ids[e],i=$("#"+n),s=i.find(".update_camp");i.addClass("gray_light"),s.prev().text("已暂停"),s.attr("mode",1).text("开启")}})},y=function(t){var a="/mnt/choose_mnt_campaign/"+t;window.open(a,"_blank")},w=function(t,a){u=t,m=a};return{init:function(){h()},setQueryDate:w,getCampaignList:b}});