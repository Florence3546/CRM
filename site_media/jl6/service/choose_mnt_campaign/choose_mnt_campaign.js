define("jl6/site_media/service/choose_mnt_campaign/choose_mnt_campaign",["jl6/site_media/service/common/common","jl6/site_media/widget/alert/alert","jl6/site_media/widget/ajax/ajax","jl6/site_media/service/add_item_box/add_item_box","jl6/site_media/plugins/data-tables/dataTableExt","jl6/site_media/plugins/jslider/js/jquery.slider"],function(common,alert,ajax,addItemBox){var sliderValue=38,init=function(){var carousel_next=!0,to_step,mnt_type=0,max_price_pc=0,max_price_yd=0,adg_counts=500,budget=0,mnt_index=Number($("#mnt_index").val()),strategy={},old_mnt_type=0,old_camp_id=0,campaign_id=parseInt($("#campaign_id").val()),loadAdg=!1;$(".next_step").on("click",function(){switch(carousel_next=!0,to_step=$(this).attr("to_step"),parseInt(to_step)){case 2:var t=$('input[name="campaign"]:checked');if(campaign_id=t.val(),$("#campaign_id").val(campaign_id),!campaign_id)return alert.show("请选择托管计划！"),!1;$(".select_compaign_name").text(t.attr("title")),old_camp_id!=campaign_id&&($(".mnt_type_desc").removeClass("checked"),$(".mnt_type_title").find(".unselect").removeClass("hide"),$(".mnt_type_title").find(".select").addClass("hide"),mnt_type=0);break;case 3:if(!mnt_type)return alert.show("还未选择托管类型！"),!1;1==mnt_type||3==mnt_type?($(".jslider-box input").slider("value",38),sliderValue=38):($(".jslider-box input").slider("value",62),sliderValue=62),setBigFactor(sliderValue),$("#campaign_budget").tooltip("hide"),$(".campaign_max_price").tooltip("hide"),ajax.ajax("get_recommend_price",{campaign_id:campaign_id,mnt_type:mnt_type},function(t){$("#campaign_budget").val(t.budget),$(".campaign_max_price").val(1==mnt_type||3==mnt_type?Math.max(2*parseFloat(t.cat_cpc),1).toFixed(2):Math.max(2*parseFloat(t.cat_cpc),2).toFixed(2)),$("#suggest_budge").text(t.budget),$("#avg_price").text(parseFloat(t.cat_cpc).toFixed(2)),$("#min_price").text(parseFloat(.2).toFixed(2)),1==mnt_type||3==mnt_type?($("#min_budget").text(30),$("#max_budget").text(3e3),$("#suggest_price").text(parseFloat(1.5*t.cat_cpc).toFixed(2)+"~"+parseFloat(2.5*t.cat_cpc).toFixed(2)),$("#price_multiple").text("1.5~2.5"),$(".set_chk_rt").addClass("hide")):($("#min_budget").text(30),$("#max_budget").text(1e4),$("#suggest_price").text(parseFloat(2*t.cat_cpc).toFixed(2)+"~"+parseFloat(3*t.cat_cpc).toFixed(2)),$("#price_multiple").text("2.0~3.0"),$(".set_chk_rt").removeClass("hide"))});break;case 4:budget=Number($("#campaign_budget").val());var e=$("#min_budget").text(),a=$("#max_budget").text();return isNaN(budget)||parseInt(budget)!=budget?($("#campaign_budget").tooltip({title:"日限额只能为整数",placement:"top",trigger:"manual"}),$("#campaign_budget").tooltip("show"),!1):budget<parseInt(e)||budget>parseInt(a)?($("#campaign_budget").tooltip({title:"日限额最低"+$("#min_budget").text()+"元，最高"+$("#max_budget").text()+"元",placement:"top",trigger:"manual"}),$("#campaign_budget").tooltip("show"),!1):(max_price_pc=Number($("#campaign_max_price_pc").val()),max_price_yd=Number($("#campaign_max_price_yd").val()),isNaN(max_price_pc)?($("#campaign_max_price_pc").tooltip({title:"请输入数字",placement:"top",trigger:"manual"}),$("#campaign_max_price_pc").tooltip("show"),!1):max_price_pc<Number($("#min_price").text())||max_price_pc>99.99?($("#campaign_max_price_pc").tooltip({title:"关键词限价最低"+Number($("#min_price").text())+"元，最高99.99元",placement:"top",trigger:"manual"}),$("#campaign_max_price_pc").tooltip("show"),!1):isNaN(max_price_yd)?($("#campaign_max_price_yd").tooltip({title:"请输入数字",placement:"top",trigger:"manual"}),$("#campaign_max_price_yd").tooltip("show"),!1):max_price_yd<Number($("#min_price").text())||max_price_yd>99.99?($("#campaign_max_price_yd").tooltip({title:"关键词限价最低"+Number($("#min_price").text())+"元，最高99.99元",placement:"top",trigger:"manual"}),$("#campaign_max_price_yd").tooltip("show"),!1):(strategy.budget=budget,strategy.max_price_pc=max_price_pc.toFixed(2),strategy.max_price_yd=max_price_yd.toFixed(2),strategy.bid_factor=get_bid_factor(),strategy.platform=get_platform(),strategy.schedule=get_schedule(),strategy.opt_wireless=get_opt_wireless(),strategy.area=get_area(),strategy.mnt_opt_type=get_chk_mnt_type(),strategy.chk_rt=0,addItemBox.setStrategy(strategy),$(".mnt_max_price_pc").text(max_price_pc.toFixed(2)),$(".mnt_max_price_yd").text(max_price_yd.toFixed(2)),$(".mnt_budget").text(budget),$(".mnt_chk_rt").text("1"==strategy.chk_rt?"开启实时优化":"关闭实时优化"),1==mnt_type||3==mnt_type?($(".mnt_service_1").removeClass("hide"),$(".mnt_service_2").addClass("hide")):($(".mnt_service_2").removeClass("hide"),$(".mnt_service_1").addClass("hide")),$("#term_service").modal({backdrop:"static",keyboard:!1}),!1));case 5:if(!addItemBox.getSelectCounts())return alert.show("请选择托管宝贝！"),!1;var i=!1;if($('input[name="adg_title"]').each(function(){return 0==$.trim($(this).val()).length||"正在获取..."==$(this).val()?(alert.show("创意标题不能为空!"),void(i=!0)):parseInt($(this).attr("char_delta"))<0?(alert.show("创意标题的长度不能超过20个汉字!"),void(i=!0)):void 0}),i)return!1;var _=$('#item_cart tbody tr[tb="1"]').length,r=$('#item_cart tbody tr[tb="0"]').length;_?($("#adg_success_count").text(_+"个宝贝即将加入托管"),$(".adg_show_div").show()):$(".adg_show_div").hide(),r?($("#item_success_count").text(r+"个宝贝即将加入托管"),$(".item_show_div").show()):$(".item_show_div").hide()}$(".progress-bar[to_step="+to_step+"]").css("width","267px"),$("#progress_step_box").carousel(parseInt(to_step)-1)}),$(".last_step").on("click",function(){carousel_next=!1,to_step=$(this).attr("to_step"),$(".progress-bar[to_step="+(parseInt(to_step)+1)+"]").css("width","0"),$(".progress_step[step="+(parseInt(to_step)+1)+"]").removeClass("current"),$("#progress_step_box").carousel(parseInt(to_step)-1)}),$("#campaign_budget,.campaign_max_price").focus(function(){$("#campaign_budget,.campaign_max_price").tooltip("destroy")}),$("#progress_step_box").on("slid.bs.carousel",function(){carousel_next&&($(".progress_step[step="+to_step+"]").addClass("current"),$(".progress_step[step="+to_step+"]").addClass("current"))}),$(":radio[name='campaign']").change(function(){$("#campaign_id").val(this.value)}),$(".mnt_type_box").click(function(){var t=$(this).find(".mnt_type_title>i");mnt_type=parseInt(t.attr("mnt_type")),adg_counts=parseInt(t.attr("adg_counts")),$(".mnt_type_desc").removeClass("checked"),$(".mnt_type_title .unselect").removeClass("hide"),$(".mnt_type_title .select").addClass("hide"),$(this).find(".unselect").addClass("hide"),$(this).find(".select").removeClass("hide"),$(".mnt_type_desc[mnt_type="+mnt_type+"]").addClass("checked"),$("#mnt_type_error").addClass("hide"),$(".select_mnt_type").text(t.attr("mnt_name"))}),$(".js_create_camp").click(function(){common.goto_ztc(1,"","","")}),$("#read_service").on("change",function(){$(this).prop("checked")?$("#check_read_service").removeClass("disabled"):$("#check_read_service").addClass("disabled")}),$("#check_read_service").click(function(){if($("#read_service").prop("checked")){$("#term_service").modal("hide");var t={mnt_type:mnt_type,adg_counts:adg_counts,cur_count:0,strategy:strategy},e={campaign_id:campaign_id,page_no:1,page_size:50,sSearch:"",exclude_existed:1,auto_hide:0};loadAdg||(addItemBox.init(t),loadAdg=!0),(old_mnt_type!=mnt_type||old_camp_id!=campaign_id)&&(old_mnt_type=mnt_type,old_camp_id=campaign_id,addItemBox.reDraw(t),addItemBox.loadItemList(e),addItemBox.loadAdgList({campaign_id:campaign_id,page_no:1,page_size:50,sSearch:"",rpt_days:7,auto_hide:0})),$("#item_cart .limit_price_pc").attr("value",strategy.max_price_pc).text(strategy.max_price_pc),$("#item_cart .limit_price_yd").attr("value",strategy.max_price_yd).text(strategy.max_price_yd),$("#item_cart .adg_cfg").attr("camp_limit",1),$(".progress-bar[to_step="+to_step+"]").css("width","267px"),$("#progress_step_box").carousel(parseInt(to_step)-1)}}),$("#no_upgrade_suggest").click(function(){window.location.href="/mnt/mnt_campaign/"+campaign_id});var step_num=0,interval,steps=$(".step-index"),ajax_step=1;$("#submit_data").click(function(){$("#submit_data").unbind("click"),$("#to_mnt_page").children("a").remove(),interval=setInterval(submitData,500),ajax.ajax("mnt_campaign_setter",{campaign_id:campaign_id,set_flag:1,mnt_type:mnt_type,max_price:strategy.max_price_pc,mobile_max_price:strategy.max_price_yd,budget:strategy.budget,mnt_index:mnt_index,mnt_rt:strategy.chk_rt,mnt_bid_factor:strategy.bid_factor,area:strategy.area,platform:strategy.platform,schedule:strategy.schedule,opt_wireless:strategy.opt_wireless},function(data){if("0"==data.result)return"no_permission"==data.error_msg?(clearInterval(interval),$("#upgrade_suggest_modal").modal({backdrop:"static",keyboard:!1})):alert.show(data.error_msg),$(steps[step_num-1]).find(".node").html('<a><i class="iconfont red" style="color:red">&#xe61e;</i></a>'),!1;if(data.warn_msg_dict){var error_dict=eval("("+data.warn_msg_dict+")");for(var error in error_dict)$("#"+error+"_error").text(error_dict[error])}ajax_step=2,$(steps[step_num]).hasClass("stop")&&(step_num++,to_next(),update_mnt_adg())},null,{url:"/mnt/ajax/"})});var submitData=function(){to_next(),$(steps[step_num]).hasClass("stop")?(2==ajax_step&&(step_num++,to_next(),update_mnt_adg()),clearInterval(interval)):step_num++},load_img=$("#load_img").attr("src"),to_next=function(){return step_num>0&&($(steps[step_num-1]).find(".node").html('<a><i class="iconfont base">&#xe63f;</i></a>'),$(steps[step_num-1]).next().addClass("base"),$(steps[step_num-1]).next().find(".step_error").fadeIn(500),step_num>=steps.length)?!1:($(steps[step_num]).parents("ul").prev(".step_name").addClass("base"),$(steps[step_num]).find(".line").addClass("bg_base"),$(steps[step_num]).find(".node").html("<img src='"+load_img+"' alt=''>"),void($(steps[step_num]).offset().top+120>$(window).height()&&$("html,body").animate({scrollTop:$(steps[step_num]).offset().top+120-$(window).height()},200)))},update_mnt_adg=function(){var t=addItemBox.getMntAdgInfo();ajax.ajax("update_mnt_adg",{mnt_adg_dict:JSON.stringify(t.mnt_adg_dict),update_creative_dict:JSON.stringify(t.update_creative_dict),new_creative_list:JSON.stringify(t.new_creative_list),camp_id:campaign_id,mnt_type:mnt_type,flag:2},function(t){t.failed_count&&($("#adg_failed_count").parent().removeClass("hide"),require(["jl6/site_media/service/add_item_box/error_adg_list"],function(e){e.setError($("#error_msg_adg"),{error_list:t.failed_item_dict})})),$("#adg_success_count").text(t.success_count+"个宝贝加入托管成功"),$("#adg_failed_count").text(t.failed_count),submit_new_item(),step_num++,to_next()},null,{url:"/mnt/ajax/"})},submit_new_item=function(){var t=addItemBox.getNewItemDict();ajax.ajax("add_new_item",{new_item_dict:JSON.stringify(t),camp_id:campaign_id,mnt_type:mnt_type},function(t){t.failed_count&&($("#item_failed_count").parent().removeClass("hide"),$("#error_msg_item").removeClass("hide"),require(["jl6/site_media/service/add_item_box/error_adg_list"],function(e){e.setError($("#error_msg_item"),{error_list:t.failed_item_dict})})),$("#item_success_count").text(t.success_count+"个宝贝加入托管成功"),$("#item_failed_count").text(t.failed_count),step_num++,to_next(),$("#to_mnt_page").html('<a class="btn btn-primary btn-sm" href="/mnt/mnt_campaign/'+campaign_id+'">进入计划主页</a>'),$(".commit_result").fadeIn(200),$("#to_mnt_main").click(function(){window.location.href="/mnt/mnt_campaign/"+campaign_id})},null,{url:"/mnt/ajax/"})};$("#select_campaign>ul>li span").click(function(){var t=$(this).parent().find("[type=radio]");t.prop("disabled")||t.prop("checked","checked")}),$(".jslider-box input").slider({from:0,to:100,skin:"power",onstatechange:function(t){setBigFactor(t)},callback:function(t){sliderValue=t}}),$("[data-toggle='tooltip']").tooltip({html:!0}),$(".select_div").on("click",":radio,:checkbox",function(t){t.stopPropagation()}),$(".select_div").click(function(){$(this).find(":radio,:checkbox").click()})},get_mnt_rt=function(){var t=$("input[name=chk_rt]:checked").val();return t},get_chk_mnt_type=function(){var t=$("input[name=chk_mnt_type]:checked").val();return parseInt(t)},get_bid_factor=function(){return $(".mnt_bid_factor").text(sliderValue>50?"偏流量导向":50==sliderValue?"均衡导向":"偏ROI导向"),sliderValue},get_schedule=function(){var t=$("input[name=schedule]").is(":checked");return t?($(".mnt_schedule").text("开启优化"),1):($(".mnt_schedule").text("未开启优化"),0)},get_platform=function(){var t=$("input[name=platform]").is(":checked");return t?($(".mnt_platform").text("开启自动优化"),1):($(".mnt_platform").text("关闭自动优化"),0)},get_opt_wireless=function(){var t=$("input[name=opt_wireless]").is(":checked");return t?($(".mnt_opt_wireless").text("开启无线投放"),1):($(".mnt_opt_wireless").text("关闭无线投放"),0)},get_area=function(){var t=$("input[name=area]").is(":checked");return t?($(".mnt_area").text("关闭港澳台、国外投放"),1):($(".mnt_area").text("开启港澳台、国外投放"),0)},setBigFactor=function(t){var e=Math.abs(t-50);50>t?($("#big_factor_name").text("偏向ROI"),$("#big_factor_value").removeClass("hide")):50==t?($("#big_factor_name").text("均衡模式"),$("#big_factor_value").addClass("hide"),$("#big_factor_value").text("0%")):($("#big_factor_name").text("偏向流量"),$("#big_factor_value").removeClass("hide")),$("#big_factor_value").text((e/50*100).toFixed(0)+"%")};return{init:function(){init()}}});