var upload_item_img_callback;define("jl6/site_media/service/image_optimize/image_optimize",["jl6/site_media/plugins/moment/moment.min","jl6/site_media/widget/alert/alert","jl6/site_media/widget/confirm/confirm","jl6/site_media/widget/loading/loading","jl6/site_media/widget/lightMsg/lightMsg","jl6/site_media/widget/ajax/ajax","jl6/site_media/plugins/kinetic/kinetic-v5.1.0.min","jl6/site_media/plugins/Jcrop/js/jquery.Jcrop.min","jl6/site_media/plugins/webfontloader/webfontloader","jl6/site_media/service/image_optimize/creative","jl6/site_media/plugins/data-tables/dataTableExt","jl6/site_media/plugins/artTemplate/template","jl6/site_media/service/report_detail/report_detail"],function(moment,alert,confirm,loading,lightMsg,ajax,kinetic,Jcrop,WebFont,_creative,_datatable,template,report_detail){function GetUrlParam(t){var e=new RegExp("(^|&)"+t+"=([^&]*)(&|$)"),i=window.location.search.substr(1).match(e);return null!=i?unescape(i[2]):null}function ChangeUrlArg(url,arg,arg_val){var pattern=arg+"=([^&]*)",replaceText=arg+"="+arg_val;if(url.match(pattern)){var tmp="/("+arg+"=)([^&]*)/gi";return tmp=url.replace(eval(tmp),replaceText)}return url.match("[?]")?url+"&"+replaceText:url+"?"+replaceText}var Jcrop_api,box_model,modify_creative_id,modify_waiting_creative_id,adgroup_id=$("#adgroup_id").val(),campaign_id=$("#campaign_id").val(),item_id=$("#item_id").val(),IDM,ICM,init=function(){IDM=new _creative.ImageDrawManager({id:"stage"}),ICM=new _creative.ImageCutManager,$("#table_box").dataTable({bRetrieve:!0,bPaginate:!1,bFilter:!0,bInfo:!1,aaSorting:[[2,"desc"]],bAutoWidth:!1,sDom:"",language:{emptyTable:"没有数据"},aoColumns:[{bSortable:!1},{bSortable:!1},{bSortable:!0,sType:"custom",sSortDataType:"custom-text"},{bSortable:!0,sType:"custom",sSortDataType:"custom-text"},{bSortable:!0,sType:"custom",sSortDataType:"custom-text"},{bSortable:!0,sType:"custom",sSortDataType:"custom-text"},{bSortable:!0,sType:"custom",sSortDataType:"custom-text"},{bSortable:!0,sType:"custom",sSortDataType:"custom-text"},{bSortable:!0,sType:"custom",sSortDataType:"custom-text"},{bSortable:!0,sType:"custom",sSortDataType:"custom-text"},{bSortable:!0,sType:"custom",sSortDataType:"custom-text"},{bSortable:!0,sType:"custom",sSortDataType:"custom-text"},{bSortable:!1}]}),$("#table_complete_box").dataTable({bRetrieve:!0,bPaginate:!1,bFilter:!0,bInfo:!1,aaSorting:[[2,"desc"]],bAutoWidth:!1,sDom:"",language:{emptyTable:"没有数据"},aoColumns:[{bSortable:!1},{bSortable:!1},{bSortable:!0},{bSortable:!0},{bSortable:!0},{bSortable:!0},{bSortable:!0},{bSortable:!0},{bSortable:!0},{bSortable:!0},{bSortable:!0},{bSortable:!0},{bSortable:!1}]}),bind_event(),$("a[data-toggle=tooltip]").tooltip()},bind_event=function(){$(".close-sign").on("click",function(){$(".sign-bar").fadeOut(200)}),$(".show_model").on("click","a",function(){if($(this).hasClass("active"))return!1;var t=$(this).find("i").attr("data-type");$(this).parent().find("a").toggleClass("active"),$(".image_optimize").toggleClass("hide"),$("#show_type").val(t),$("#add_image").toggleClass("hide");var e=GetUrlParam("t");window.location.href=e?ChangeUrlArg(window.location.href,"t",t):window.location.href+"&t="+t}),$(document).on("click.image_optimize.modify_title",".modify_title",function(){var t,e=$(this).closest(".item");t=e.find(".title").text(),e.find(".input_title").val(t),e.find(".j_text_len").text(true_length(t)),e.addClass("editor")}),$(document).on("click.image_optimize.cancel_modify_title",".cancel_modify_title",function(){var t=$(this).closest(".item");t.removeClass("editor")}),$("#list_add_box .img").on("click.image_optimize.img.modify_creative",function(){var t,e=$(this).find("img").attr("src");modify_creative_id=$(this).find("img").attr("data-id"),t=$(this).next().text(),IDM.draw(e,function(){$("#img_cut").attr("src",e),set_box_model(0),$(".item_main_pic li:eq(0)").removeClass("checked"),$("#switch_optimize").trigger("click"),$("#image_optimize_modal").find(".title").text(t),$("#image_optimize_modal").modal({keyboard:!1,backdrop:"static"}),updateStyleBox(e)})}),$("#table_box").on("click",".edit_image",function(){var t,e=$(this).parents("tr").find("img").attr("data-url");modify_creative_id=$(this).parents("tr").find("img").attr("data-id"),t=$(this).parents("tr").find(".adg_title").text(),IDM.draw(e,function(){$("#img_cut").attr("src",e),set_box_model(0),$(".item_main_pic li:eq(0)").removeClass("checked"),$("#switch_optimize").trigger("click"),$("#image_optimize_modal").find(".title").text(t),$("#image_optimize_modal").modal({keyboard:!1,backdrop:"static"}),updateStyleBox(e)})}),$("#list_add_test_box .img").on("click.image_optimize.img.modify_creative",function(){var t,e=$(this).find("img").attr("src");modify_waiting_creative_id=$(this).find("img").attr("data-id"),t=$(this).next().text(),IDM.draw(e,function(){$("#img_cut").attr("src",e),set_box_model(3),$(".item_main_pic li:eq(0)").removeClass("checked"),$("#switch_optimize").trigger("click"),$("#image_optimize_modal").find(".title").text(t),$("#image_optimize_modal").modal({keyboard:!1,backdrop:"static"}),updateStyleBox(e)})}),$("#table_test_box").on("click",".edit_image",function(){var t,e=$(this).parents("tr").find("img").attr("data-url");modify_waiting_creative_id=$(this).parents("tr").find("img").attr("data-id"),t=$(this).parents("tr").find(".title").text(),IDM.draw(e,function(){$("#img_cut").attr("src",e),set_box_model(3),$(".item_main_pic li:eq(0)").removeClass("checked"),$("#switch_optimize").trigger("click"),$("#image_optimize_modal").find(".title").text(t),$("#image_optimize_modal").modal({keyboard:!1,backdrop:"static"}),updateStyleBox(e)})}),$(document).on("click","#list_add_box .add_creative,#add_new_img",function(){var t=$("#list_add_box .item:first .title").text();$("#image_optimize_modal").find(".title").text(t),$(".item_main_pic li:eq(0)").trigger("click"),set_box_model(1),$("#rechoose_img").trigger("click"),$("#image_optimize_modal").modal({keyboard:!1,backdrop:"static"})}),$(document).on("click","#list_add_test_box .add_creative,#add_test_img",function(){var t=$("#list_add_box .item:first .title").text();$("#image_optimize_modal").find(".title").text(t),$(".item_main_pic li:eq(0)").trigger("click"),set_box_model(2),$("#rechoose_img").trigger("click"),$("#image_optimize_modal").modal({keyboard:!1,backdrop:"static"})}),$("#list_add_box .delete_creative,#table_box .delete_image").on("click.image_optimize.delete_creative",function(){var t;t=$(this).attr("data-id"),confirm.show({body:"你确定要删除吗？",okHidden:function(){loading.show("正在删除，请稍候..."),ajax.ajax("del_creative",{adgroup_id:adgroup_id,creative_id:t},delete_creative_callback)}})}),$("#list_add_test_box .delete_creative,#table_test_box .delete_image").on("click.image_optimize.delete_creative",function(){var t=$(this).attr("data-id");confirm.show({body:"你确定要删除吗？",okHidden:function(){loading.show("正在删除，请稍候..."),ajax.ajax("delete_waiting_creative",{adgroup_id:adgroup_id,creative_id:t,auto_hide:0},delete_creative_callback)}})}),$("#complete_creatives_box .delete_creative,#table_complete_box .delete_image").on("click.image_optimize.delete_creative",function(){var t=$(this).attr("data-id");confirm.show({body:"你确定要删除吗？",okHidden:function(){loading.show("正在删除，请稍候..."),ajax.ajax("delete_waiting_creative",{adgroup_id:adgroup_id,creative_id:t,auto_hide:0},delete_creative_callback)}})}),$("#complete_creatives_box .reset_creative").on("click.image_optimize.reset_creative",function(){var t,e,i=$(this).closest(".item2"),a=Number($("#creative_count").val());return 4==a?(alert.show("请先删除一个投放中创意"),!1):(t=i.find(".title").text(),e=i.find("img").attr("src"),void IDM.draw(e,function(){$("#img_cut").attr("src",e),set_box_model(1),$(".item_main_pic li:eq(0)").removeClass("checked"),$("#rechoose_img").trigger("click"),$("#image_optimize_modal").find(".title").text(t),$("#image_optimize_modal").modal({keyboard:!1,backdrop:"static"}),updateStyleBox(e)}))}),$("#table_complete_box .reset_creative").on("click.image_optimize.reset_creative",function(){var t,e,i=$(this).parents("tr"),a=Number($("#creative_count").val());return 4==a?(alert.show("请先删除一个投放中创意"),!1):(t=i.find(".adg_title").text(),e=i.find("img").attr("src"),void IDM.draw(e,function(){$("#img_cut").attr("src",e),set_box_model(1),$(".item_main_pic li:eq(0)").removeClass("checked"),$("#rechoose_img").trigger("click"),$("#image_optimize_modal").find(".title").text(t),$("#image_optimize_modal").modal({keyboard:!1,backdrop:"static"}),updateStyleBox(e)}))}),$("#complete_creatives_box .reset_waiting_creative").on("click.image_optimize.reset_waiting_creative",function(){var t,e,i=$(this).closest(".item2"),a=Number($("#waiting_creatives_count").val());return 4==a?(alert.show("请先删除一个排队中创意"),!1):(t=i.find(".title").text(),e=i.find("img").attr("src"),void IDM.draw(e,function(){$("#img_cut").attr("src",e),set_box_model(2),$(".item_main_pic li:eq(0)").removeClass("checked"),$("#rechoose_img").trigger("click"),$("#image_optimize_modal").find(".title").text(t),$("#image_optimize_modal").modal({keyboard:!1,backdrop:"static"}),updateStyleBox(e)}))}),$("#table_complete_box .reset_waiting_creative").on("click",function(){var t,e,i=$(this).parents("tr"),a=Number($("#waiting_creatives_count").val());return 4==a?(alert.show("请先删除一个排队中创意"),!1):(t=i.find(".adg_title").text(),e=i.find("img").attr("src"),void IDM.draw(e,function(){$("#img_cut").attr("src",e),set_box_model(2),$(".item_main_pic li:eq(0)").removeClass("checked"),$("#rechoose_img").trigger("click"),$("#image_optimize_modal").find(".title").text(t),$("#image_optimize_modal").modal({keyboard:!1,backdrop:"static"}),updateStyleBox(e)}))}),$(".editor_title .input_title").on("keyup.image_optimize",function(){var t=true_length(this.value);$(this).next().find(".j_text_len").text(t)}),$("#list_add_box,#table_box").on("click",".save_title",function(){var t,e,i=$(this).attr("data-id"),a=$(this).closest(".item");t=a.find(".input_title").val();var o=a.find(".title").text();return e=a.find(".img img").attr("data-url"),true_length(t)>40?(alert.show("创意标题限制为40个字符之内，请修改后再次保存"),!1):0==true_length(t)?(alert.show("创意标题不能为空，请修改后再次保存"),!1):(a.removeClass("editor"),t==o?!1:(loading.show("正在修改，请稍候..."),void ajax.ajax("super_update_creative",{item_id:item_id,adgroup_id:adgroup_id,campaign_id:campaign_id,creative_id:i,title:t,img_str:e},update_creative_callback)))}),$("#list_add_test_box,#table_test_box").on("click",".save_title",function(){var t,e=$(this).attr("data-id"),i=$(this).closest(".item");t=i.find(".input_title").val();var a=i.find(".title").text();return true_length(t)>40?(alert.show("创意标题限制为40个字符之内，请修改后再次保存"),!1):0==true_length(t)?(alert.show("创意标题不能为空，请修改后再次保存"),!1):(i.removeClass("editor"),t==a?!1:(loading.show("正在修改，请稍候..."),void ajax.ajax("update_waiting_creative",{id:e,title:t},update_test_title_callback)))}),report_detail.init(1,1),$(".show_chart").on("click",function(){var t=$(this).attr("data-id"),e=$("#item_"+t+" .title").text();report_detail.show("创意明细："+e,"creative",$("#shop_id").val(),null,null,t)}),$(document).on("click.image_optimize.switch_optimize","#switch_optimize",function(){$("#switch_optimize").hide(),$("#rechoose_img").show(),$(".operation_box").addClass("optimize")}),$("#image_optimize_modal .sync_title").on("click.image_optimize.sync_title",function(){var t,e=$(this).closest(".item");return t=e.find("textarea").val(),true_length(t)>40?(alert.show("创意标题限制为40个字符之内，请修改后再次保存"),!1):""==t?(alert.show("创意标题不能为空，请修改后再次点击确定"),!1):(e.find(".title").text(t),void e.removeClass("editor"))}),$(document).on("click.image_optimize.item_main_pic",".item_main_pic li:not(.add)",function(){var t=this;IDM.draw($(this).find("img").attr("data-url"),function(){$(".item_main_pic li").removeClass("checked"),$(".preview_layer").removeClass("checked"),$(t).addClass("checked"),updateStyleBox($(t).find("img").attr("data-url"))})}),$("#upload_item_img_input").on("change",function(){var t=this.files.item(0);return t.type.match("image.*")?t.size>10485760?(alert.show("图片过大请保证在10M以内"),!1):(loading.show("正在上传图片，请稍候...","",!0),void $("#upload_item_img_form").submit()):(alert.show("只允许图片格式的文件，如 jpg png gif"),!1)}),$(document).on("click.image_optimize.delete_main_pic",".item_main_pic i.delete",function(t){var e;t.stopPropagation(),e=$(this).next().attr("data-img-id"),confirm.show({body:"你确定要删除吗？",backdrop:!1,okHidden:function(){ajax.ajax("delete_main_pic",{item_id:item_id,img_id:e},delete_main_pic_callback)}})}),$(document).on("click.image_optimize.preview_layer",".preview_layer",function(){var t=this;IDM.draw($(this).find("img").attr("src"),function(){$(".item_main_pic li").removeClass("checked"),$(t).addClass("checked"),updateStyleBox($(t).find("img").attr("src"))})}),$(document).on("click.image_optimize.switch_optimize","#switch_optimize",function(){$("#switch_optimize").hide(),$("#rechoose_img").show(),$(".operation_box").addClass("optimize")}),$(document).on("click.image_optimize.rechoose_img","#rechoose_img",function(){$("#switch_optimize").show(),$("#rechoose_img").hide(),$(".operation_box").removeClass("optimize")}),$("#img_cut_modal").on("hidden.bs.modal",function(){$("#image_optimize_modal").css("z-index",$("#img_cut_modal").css("z-index"))}),$(document).on("click.image_optimize.switch_img_cut","#switch_img_cut",function(){var t=current_img_url()||$("#img_cut").attr("src");IDM.load_img(t,function(){var e=this;$("#img_cut").attr("src",t),$("#img_cut").css({width:ICM.options.width,height:this.height*(ICM.options.width/this.width)}),$("#img_cut_modal").modal({backdrop:!1}),ICM.cut("img_cut",this,function(t){var i=e.width/ICM.options.width;IDM.cut_img(-t.x,-t.y,t.w,t.h,i)},function(){Jcrop_api=this})})}),$("#img_cut_modal").on("click",".btn-default",function(){current_img_url()||$("#img_cut").attr("src");IDM.recover_cut_img(),Jcrop_api.destroy(),$("#img_cut_modal").modal("hide")}),$("#img_cut_modal").on("click",".btn-primary",function(){Jcrop_api.destroy(),$("#img_cut_modal").modal("hide")}),$("#img_cut_modal").on("hidden.bs.modal",function(){$("body").addClass("modal-open")}),$(document).on("click.image_optimize.switch_style",".style_box>li",function(){var t;t=$(this).find("img").attr("data-temp"),IDM.init_draw(t,function(){var e=this.style_config[t],i="";for(var a in e){var o,d,c;o=e[a].index,d=e[a].config_id,void 0==d&&(d=o);var c=this.template[d];for(var l in c)i+=-1!=l.indexOf("color")||-1!=l.indexOf("fontsize")?'<input type="hidden" data-index="'+e[a].index+'" data-text="'+l+'" value="'+c[l]+'">':'<input type="text" data-index="'+e[a].index+'" data-text="'+l+'" value="'+c[l]+'">'}$("#text_control").html(i),$("#choose_tip").hide()}),$(".style_box>li").removeClass("checked"),$(this).addClass("checked"),ajax.ajax("record_template_click",{temp_id:$(this).find("img").attr("data-temp")},null)}),$("#clean_flag").on("click",function(){IDM.clear_group(),IDM.redraw_layer(),$("#text_control").html(""),$("#choose_tip").show(),$(".style_box li").removeClass("checked")}),$(document).on("click",".optimize_style .pagination li:not(.active)",function(){var t,e=$(this).closest(".pagination"),i=1;e.data("count")&&(i=e.data("count")),e.find("li").removeClass("active"),$(this).hasClass("first")?(t=1,$(this).next().addClass("active")):$(this).hasClass("last")?(t=i,$(this).prev().addClass("active")):(t=Number($(this).text()),$(this).addClass("active")),e.prev().find(".style_box").css("marginTop",-$(".style_warp").height()*(t-1)),i>7&&reDrawPage(e,i,t)}),$("#local_upload_creative").on("change",function(){var t,e=this.files.item(0);e&&(t=IDM.create_object_url(e),IDM.draw(t),updateStyleBox(t),$(".preview_layer img").attr("src",t),$(".local_pic .empty").removeClass("empty").addClass("rechoose"),$(".item_main_pic li").removeClass("checked"),$(".preview_layer").addClass("checked"))}),$("#text_control").on("keyup","input",function(){var t,e={};t=$(".style_box>li.checked").find("img").attr("data-temp"),$("#text_control input").each(function(){var t,i=$(this);index=i.attr("data-index"),t=i.attr("data-text"),"undefined"==typeof e[index]&&(e[index]={}),e[index][t]=this.value}),IDM.draw_by_custom(t,e)}),$("#image_optimize_modal").on("click","[action=confirm]",function(){IDM.get_base64(function(t){var e,i=$(".preview_box .title").text(),a="",o={item_id:item_id,adgroup_id:adgroup_id,campaign_id:campaign_id,title:i,img_str:t,auto_hide:0};0==box_model&&(o.creative_id=modify_creative_id,a="super_update_creative",loading.show("正在修改，请稍候..."),e=update_creative_callback),1==box_model&&(a="super_add_creative",loading.show("正在添加，请稍候..."),e=add_creative_callback),2==box_model&&(a="create_waiting_creative",loading.show("正在添加，请稍候..."),e=function(){loading.hide(),window.location.reload()}),3==box_model&&(o.id=modify_waiting_creative_id,a="super_update_waiting_creative",loading.show("正在修改，请稍候..."),e=function(){loading.hide(),window.location.reload()}),ajax.ajax(a,o,e)})}),IDM.group_mouseover=function(){$("body").addClass("poi")},IDM.group_mouseleave=function(){$("body").removeClass("poi")},$(".optimize_style .nav a").on("shown",function(){lazy_load($(".optimize_style .tab-pane.active img"))}),$("#select_days").on("change",function(){sdate=moment($(this).daterangepicker("getRange").start).format("YYYY-MM-DD"),edate=moment($(this).daterangepicker("getRange").end).format("YYYY-MM-DD");var t=GetUrlParam("s"),e=GetUrlParam("e");if(t&&e){var i=ChangeUrlArg(window.location.href,"s",sdate);window.location.href=ChangeUrlArg(i,"e",edate)}else window.location.href=window.location.href+"&s="+sdate+"&e="+edate}),$("#btn_local_upload").click(function(){$("#local_upload_creative").click()}),$(".tips").tooltip()},true_length=function(t){for(var e=0,i=0;i<t.length;i++)t[i].charCodeAt(0)<299?e++:e+=2;return e},set_box_model=function(t){var e={0:"编辑创意",1:"添加新创意",2:"添加测试创意",3:"编辑测试创意"},i=$("#image_optimize_modal");i.find(".modal-header h4").text(e[t]),i.find(".modal-footer [action=confirm]").text(e[t].replace(/添加|编辑/,"提交")),box_model=t},current_img_url=function(){return $(".choose_pic_box .checked img").attr("data-url")||$(".choose_pic_box .checked img").attr("src")},check_font=function(){WebFont.load({custom:{families:["FZZZHJT","FZCHJT","FZYY","IMPACTR","LTH","ICON","HYYYT","LTCH"]},loading:function(){},active:function(){}})},lazy_load=function(t){for(var e=0;e<t.length;e++)void 0!=$(t[e]).attr("data-src")&&(t[e].src=$(t[e]).attr("data-src"),$(t[e]).removeAttr("data-src"))},add_creative_callback=function(){loading.hide(),window.location.reload()},delete_creative_callback=function(){window.location.reload()},create_waiting_creative_callback=function(){window.location.reload()},update_creative_callback=function(t){if(t.reload)window.location.reload();else{loading.hide();var e;e=$("#item_"+t.creative_id),e.find(".title").text(t.title),lightMsg.show({body:"修改成功！"})}},update_test_title_callback=function(t){loading.hide();var e;e=$(".item_test_"+t.id),e.find(".title").text(t.title),lightMsg.show({body:"修改成功！"})},delete_main_pic_callback=function(t){if(t.msg)alert.show(t.msg);else{var e=$(".item_main_pic img[data-img-id="+t.data.img_id+"]").parent();e.hasClass("checked")&&$(".item_main_pic li:eq(0)").trigger("click"),e.remove(),$(".item_main_pic li.add").removeClass("hide"),$("#upload_item_img_input").val("")}};upload_item_img_callback=function(t){loading.hide(),$(".item_main_pic li.add").before('<li><i class="iconfont delete">&#xe627;</i> <img src="'+t.url+'_100x100.jpg" data-url="'+t.url+'" data-img-id="'+t.img_id+'"></li>'),$(".item_main_pic li.add").prev().trigger("click"),$(".item_main_pic li:not(.add)").length>=5&&$(".item_main_pic li.add").addClass("hide")};var show_creative_trend=function(t){$("#modal_camp_trend").length||$("body").append(pt_tpm["modal_camp_trend.tpm.html"]),$("#camp_trend_title").text("创意"),require(["jl6/site_media/service/image_optimize/modal_camp_trend"],function(e){e.show({title:t.title},t.category_list,t.series_cfg_list)}),$("#modal_camp_trend").modal()},reDrawPage=function(t,e,i){var a=3,o=2*a+1,d=1,c=1;a+1>=i?c=Math.min(o,e):(d=i-a,c=a>e?e:i+a),i+3>e&&e>o&&(d=e-o+1,c=e+1);for(var l=$(t).find("li"),r=0;r<l.length;r++)r>=d&&c>=r?$(l[r]).removeClass("hide"):0!=r&&r!=e+1&&$(l[r]).addClass("hide")},updateStyleBox=function(t){$("#image_optimize_modal .style_warp>ul>li").css("backgroundImage","url("+t+")")};return{init:function(){init(),check_font(),lazy_load($(".optimize_style .tab-pane.active img"))}}});