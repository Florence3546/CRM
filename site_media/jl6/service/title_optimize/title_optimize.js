define("jl6/site_media/service/title_optimize/title_optimize",["require","jl6/site_media/service/common/common","jl6/site_media/plugins/artTemplate/template","jl6/site_media/plugins/caret/jquery.caret.min","jl6/site_media/plugins/jquery-tag-editor/jquery.tag-editor.min","jl6/site_media/widget/alert/alert","jl6/site_media/widget/ajax/ajax","jl6/site_media/widget/lightMsg/lightMsg","jl6/site_media/widget/loading/loading","jl6/site_media/plugins/data-tables/dataTableExt","jl6/site_media/plugins/zclip/jquery.zclip.min"],function(require,common,template,caret,tagEditor,alert,ajax,lightMsg,loading,dataTable){"use strict";var title_elemword_list=$("#title_word_str").length&&$("#title_word_str").val().split(","),adgroup_id=$("#adgroup_id").val(),item_id=$("#item_id").val(),refresh_residue=function(){var t=10;$("#title_input ul.tag-editor li").each(function(){t+=$(this).width()}),$("#residue").css("left",t)},get_tags=function(t){return t.tagEditor("getTags")[0].tags},get_tags_value=function(t){var e="",i=get_tags(t);for(var l in i)e+=i[l];return e},remove_all_tags=function(t){t.text("");var e=get_tags(t);for(var i in e)t.tagEditor("removeTag",e[i])},show_title_box=function(){$("#select_title_box").height($(".title_box").height())},hide_title_box=function(){$("#select_title_box").height(0)},init=function(){getRemainLength($("#title_word_str").val().replace(new RegExp(/(,)/g),"")),$("[data-toggle=tooltip]").tooltip();for(var i in title_elemword_list)$('.title_box li a[value="'+title_elemword_list[i]+'"]').parent().addClass("select");var options={placeholder:"",initialTags:title_elemword_list,removeDuplicates:!1,onChange:function(t,e,i){$("#select_title_box ul.pt-tag>li").removeClass("select");var l="";for(var a in i)l+=i[a],$('#select_title_box a[value="'+i[a]+'"]').parent("li").addClass("select");getRemainLength(l)}};$("#adg_title").tagEditor(options),$("#title_input").on("keydown",".tag-editor-tag input",function(){getRemainLength($("#adg_title").next("ul").find(".tag-editor-tag").text())}),$("#title_input").focusin(function(){show_title_box()}),$(document).click(function(t){0==$(t.target).closest("#title_input").length&&0==$(t.target).closest("#table_titles td.title").length&&(hide_title_box(),getRemainLength($("#adg_title").next("ul").find(".tag-editor-tag").text()))}),$("#btn_create_title").click(function(){var t=get_tags_value($("#adg_title"));if(0==t.length)return void alert.show("亲，标题不能为空");if(bytes_len(t)>60)return void alert.show("标题长度不能超过30个汉字");if(is_duplicate_title(t))return void alert.show("列表中已存在相同的标题");var e=$("#table_titles tr[title_num]:last").attr("title_num"),i=String(Number(e)+1),l='<tr title_num="{{ title_num }}" class="hidden {{ extra_class }}">\n    <td data-title="编号" class="tc">{{ title_num }}</td>\n    <td data-title="参考标题" class="title"><span class="title l adg_title">{{ title }}</span><i class="iconfont edit_title ml5 base_color poi">&#xe609;</i></td>\n    <td data-title="引流能力"><span class="title_traffic_score"></span><i class="iconfont ml5 icon-add base_color poi f14 b">&#xe605;</i><i class="iconfont hide ml5 icon-del base_color poi f14 b">&#xe604;</i></td>\n    <td data-title="操作">\n	    <a href="javascript:void(0);" class="btn submit_title btn-primary btn-sm">提交</a>\n	    {{ if (extra_class==\'rec_title\') }}\n	    <span class="ml5 poi" data-toggle="tooltip" data-placement="top" data-trigger="hover" title="系统推荐的标题可能与宝贝实际属性有偏差，且默认不加品牌词和促销词，请酌情手动调整！">[系统推荐]</span>\n	    {{ /if }}\n    </td>\n</tr>\n',a=template.compile(l)({title_num:i,title:t});$("#table_titles>tbody").append(a),$("#table_titles tr[title_num='"+i+"'] span.title").data("title_elemword_list",get_tags($("#adg_title"))),get_title_traffic_score(t,i,get_tags($("#adg_title")))}),$("#btn_copy_title").zclip({path:"/site_media/jl6/plugins/zclip/ZeroClipboard.swf",copy:function(){var t=get_tags_value($("#adg_title"));return 0==t.trim().length?"":t},afterCopy:function(){var t=get_tags_value($("#adg_title"));0==t.trim().length?alert.show("亲，标题不能为空"):lightMsg.show("标题已经复制到剪贴板！")}}),$("#table_titles").on("click","a.submit_title:not(.current_title)",function(){var t=$(this).closest("tr"),e=t.find("span.title").text();if(e==$("#item_title").html())alert.show("与宝贝当前标题相同");else{var i=t.attr("title_num");submit_title(e,i)}}),$("#remove_all_tags").click(function(){remove_all_tags($("#adg_title")),$(".pt-tag>li").removeClass("select")}),$("#table_titles tr[title_num='0'] span.title").data("title_elemword_list",title_elemword_list),get_title_traffic_score($("#item_title").html(),0,title_elemword_list),$(".pt-tag>li").click(function(){if($(this).hasClass("select"))$(this).removeClass("select"),$("#adg_title").tagEditor("removeTag",$(this).text());else{var t=get_tags_value($("#adg_title"));bytes_len(t)<=60?($(this).addClass("select"),$("#adg_title").tagEditor("addTag",$(this).text())):alert.show("标题长度不能超过30个汉字")}}),$(document).on("click",".edit_title",function(){remove_all_tags($("#adg_title"));var t=$(this).prev("span.title").data("title_elemword_list");$(".title_box li").removeClass("select");for(var e in t)$('.title_box li a[value="'+t[e]+'"]').parent().addClass("select"),$("#adg_title").tagEditor("addTag",t[e]);show_title_box()}),$("#adgroup_property").on("click",function(){$("#adgroup_property_box").toggleClass("hide"),$(".open-property").toggleClass("hide"),$(".close-property").toggleClass("hide"),$("#select_title_box").height($(".title_box").height())}),$("#div_prmtword, #div_dcrtword, #div_propword, #div_prdtword").each(function(){$(this).find("li").length>14&&$(this).find("li:last").after('<a href="javascript:;"><i class="iconfont ml5 open-more b">&#xe605;</i><i class="iconfont ml5 hide close-more b">&#xe604;</i></a>')}),$(document).on("click",".open-more",function(){$(this).toggleClass("hide");var t=$(this).siblings();t.toggleClass("hide"),$(this).parent().siblings().animate({opacity:"show"},"normal"),$("#select_title_box").height($(".title_box").height())}),$(document).on("click",".close-more",function(){$(this).toggleClass("hide");var t=$(this).siblings();t.toggleClass("hide"),$(this).parent().siblings("li:gt(13)").animate({opacity:"hide"},"fast",function(){$("#select_title_box").height($(".title_box").height())})}),$("#table_titles").on("click",".icon-add",function(){var title_num,kw_list,title_tr=$(this).closest("tr");title_num=title_tr.attr("title_num"),kw_list=title_tr.find("span.title").data("kw_list"),show_title_kw(title_num,eval("("+kw_list+")")),$(this).toggleClass("hide"),$(this).siblings("i").toggleClass("hide")}),$("#table_titles").on("click",".icon-del",function(){var t=$(this).closest("tr");t.next().remove(),$(this).toggleClass("hide"),$(this).siblings("i").toggleClass("hide")})},submit_title=function(t,e){ajax.ajax("update_item",{title:t,item_id:item_id,adgroup_id:$("#adgroup_id").val(),campaign_id:$("#campaign_id").val(),title_num:e},set_current_title)},set_current_title=function(t){$("#item_title").html(t.title),$(".current_title").html("提交").addClass("btn submit_title btn-primary btn-sm").removeClass("current_title");var e=$("#table_titles [title_num='"+t.title_num+"'] .submit_title");e.html("当前标题"),e.unbind("click"),e.addClass("current_title").removeClass("btn submit_title btn-primary btn-sm"),alert.show("提交成功")},is_duplicate_title=function(t){for(var e=$("#table_titles").find(".adg_title"),i=0;i<e.length;i++)if(t==$(e[i]).text())return!0;return!1},bytes_len=function(t){for(var e=0,i=0;i<t.length;i++)e+=t.charCodeAt(i)>255?2:1;return e},getRemainLength=function(t){var e=Math.floor(30-bytes_len(t)/2);return e>=0?($("#remain_char_prompt").parent().removeClass("red"),$("#remain_char_prompt").html("还可输入"),$("#remain_char_count").html(e)):($("#remain_char_prompt").parent().addClass("red"),$("#remain_char_prompt").html("已超过"),$("#remain_char_count").html(Math.abs(e))),e},get_title_traffic_score=function(t,e,i,l){loading.show("正在统计引流指数"),$("#table_titles>tbody>tr:not([title_num])").remove(),ajax.ajax("get_title_traffic_score",{title:t,title_num:e,title_elemword_list:i,item_id:item_id,is_rec_title:l||0},show_title_traffic_score),hide_title_box()},get_traffic_score=function(kw_list){kw_list=eval("("+kw_list+")");for(var title_traffic_score=0,i=0;i<kw_list.length;i++)title_traffic_score+=kw_list[i][3];return title_traffic_score.toFixed(2)},show_title_traffic_score=function(t){loading.hide();var e=t.data,i=Number(get_traffic_score(e.kw_list)),l=Number($("#table_titles tr[title_num=0] .title_traffic_score").html());if(e.is_rec_title&&l>i)return void $('#table_titles tr[title_num="'+e.title_num+'"]').remove();$('#table_titles tr[title_num="'+e.title_num+'"]').removeClass("hidden"),$('#table_titles tr[title_num="'+e.title_num+'"] .title_traffic_score').html(i);var a=$('#table_titles tr[title_num="'+e.title_num+'"] span.title');a.data("kw_list",e.kw_list),a.data("title_traffic_score",i);var s=$("#table_titles").data("title_list")||[];s.push(e.title),$("#table_titles").data("title_list",e.title_list),"0"==e.title_num&&(loading.show("正在生成系统推荐标题"),ajax.ajax("generate_rec_title",{item_id:item_id},generate_rec_title_back))},generate_rec_title_back=function(data){loading.hide();var tpl='<tr title_num="{{ title_num }}" class="hidden {{ extra_class }}">\n    <td data-title="编号" class="tc">{{ title_num }}</td>\n    <td data-title="参考标题" class="title"><span class="title l adg_title">{{ title }}</span><i class="iconfont edit_title ml5 base_color poi">&#xe609;</i></td>\n    <td data-title="引流能力"><span class="title_traffic_score"></span><i class="iconfont ml5 icon-add base_color poi f14 b">&#xe605;</i><i class="iconfont hide ml5 icon-del base_color poi f14 b">&#xe604;</i></td>\n    <td data-title="操作">\n	    <a href="javascript:void(0);" class="btn submit_title btn-primary btn-sm">提交</a>\n	    {{ if (extra_class==\'rec_title\') }}\n	    <span class="ml5 poi" data-toggle="tooltip" data-placement="top" data-trigger="hover" title="系统推荐的标题可能与宝贝实际属性有偏差，且默认不加品牌词和促销词，请酌情手动调整！">[系统推荐]</span>\n	    {{ /if }}\n    </td>\n</tr>\n',title_tr=template.compile(tpl)({title_num:1,title:data.rec_title,extra_class:"rec_title"});$("#table_titles>tbody").append(title_tr),$("#table_titles tr[title_num='1'] span.title").data("title_elemword_list",eval("("+data.title_elemword_list+")")),get_title_traffic_score(data.rec_title,1,data.title_elemword_list,1),$("[data-toggle=tooltip]").tooltip()},show_title_kw=function(t,e){var i='<tr>\n    <td  style="padding: 0px;" colspan="4">\n        <table class="table table-bordered table-no-warp-border"></table>\n    </td>\n</tr>\n',l=template.compile(i)(),a=$('#table_titles tr[title_num="'+t+'"]').after(l);a.next().find("table").dataTable({aaData:e,aoColumns:[{sTitle:"<div>关键词</div>"},{sTitle:"<div>搜索指数</div>"},{sTitle:"<div>竞争度</div>"},{sTitle:"<div>引流能力</div>"}],aaSorting:[[3,"desc"]],bDestroy:!0,bFilter:!1,bLengthChange:!1,bInfo:!1,bPaginate:!1,sDom:"",oLanguage:{sInfo:"总共_TOTAL_条记录",sInfoEmpty:"",sEmptyTable:"亲，没有找到匹配的关键词"}})};return{init:function(){init()}}});